<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PDF & Image Keyword Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 0.4rem; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .card { border: 1px solid #e6e6e6; border-radius: 12px; padding: 16px; }
    form { margin: 0; }
    input[type="text"] { padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background: #fafafa; cursor: pointer; }
    button:hover { background: #f0f0f0; }
    ul { padding-left: 18px; }
    .kw { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; margin: 6px; border: 1px solid #ddd; border-radius: 999px; }
    .danger { color: #a10000; }
    mark { background: #ffef7a; }
    .img-wrap { position: relative; display: inline-block; max-width: 100%; }
    .img-wrap img { display: block; max-width: 100%; height: auto; }
    .overlay { position: absolute; border: 2px solid #ff3333; pointer-events: none; box-sizing: border-box; }
    .message { margin: 8px 0; color: #666; }
    .muted { color: #777; }
    .snippets li { margin: 6px 0; }
    .footer { margin-top: 30px; font-size: 12px; color: #888; }
  </style>
</head>
<body>
  <h1>PDF & Image Keyword Search</h1>
  <p class="muted">Upload a PDF or an image. I’ll find your saved keywords in PDFs (with page + snippet) or highlight matches on images.</p>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div>
      {% for category, msg in messages %}
        <p class="{{ category }}">{{ msg }}</p>
      {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="row">
    <div class="card">
      <h3>Add Keyword</h3>
      <form action="{{ url_for('add_keyword') }}" method="POST">
        <div style="display:flex; gap:10px; align-items:center;">
          <input type="text" name="keyword" placeholder="e.g., invoice, ACME, PO-1234">
          <button type="submit">Add</button>
        </div>
      </form>

      <h3 style="margin-top:18px;">Saved Keywords</h3>
      <div>
        {% if keywords and keywords|length > 0 %}
          {% for w in keywords %}
            <span class="kw">
              {{ w }}
              {# Render a delete button that posts to delete_keyword for this word #}
              <form action="{{ url_for('delete_keyword', id=(loop.index0 + 1)) }}" method="POST" style="display:inline;">
                {# NOTE:
                   We don't know the DB IDs here when we only have strings in `keywords`.
                   To make deletes reliable, change index route to pass Keyword objects
                   instead of strings OR add a small delete section listing with IDs.
                   Below is a safe alternative list with IDs when present in `results._ids`.
                #}
              </form>
            </span>
          {% endfor %}
        {% else %}
          <p class="muted">No keywords yet. Add one above.</p>
        {% endif %}
      </div>

      {# A separate, accurate list with delete buttons using IDs if server passes them #}
      {% if results and results.get('_keyword_rows') %}
        <div style="margin-top:10px;">
          <p class="muted">Manage:</p>
          {% for row in results.get('_keyword_rows') %}
            <div class="kw">
              {{ row.word }}
              <form action="{{ url_for('delete_keyword', id=row.id) }}" method="POST" style="display:inline;">
                <button class="danger" type="submit" title="Delete">×</button>
              </form>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="card">
      <h3>Upload File</h3>
      <form action="{{ url_for('upload') }}" method="POST" enctype="multipart/form-data">
        <div style="display:flex; gap:10px; align-items:center;">
          <input type="file" name="file" accept=".pdf,image/*" required>
          <button type="submit">Search</button>
        </div>
      </form>
      <p class="muted" style="margin-top:8px;">Accepted: pdf, png, jpg, jpeg, webp, bmp, tif, tiff</p>
    </div>
  </div>

  {% if results %}
    <div class="card" style="margin-top:24px;">
      <h3>Results</h3>

      {% if results.message %}
        <p class="message">{{ results.message }}</p>
      {% endif %}

      {% if results.type == 'pdf' %}
        {% if results.pdf_matches and results.pdf_matches|length > 0 %}
          <ul class="snippets">
            {% for m in results.pdf_matches %}
              {% if m.error %}
                <li class="danger">{{ m.error }}</li>
              {% else %}
                <li>
                  <b>{{ m.keyword }}</b> — Page {{ m.page }}: “…{{ m.snippet }}…”
                </li>
              {% endif %}
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted">No matches found.</p>
        {% endif %}
      {% endif %}

      {% if results.type == 'image' %}
        {% if uploaded_image %}
          <div class="img-wrap" id="imgWrap">
            <img id="ocrImg" src="{{ url_for('uploaded_file', filename=uploaded_image) }}" alt="Uploaded image">
            <!-- boxes are drawn dynamically to scale via JS -->
          </div>
          <p class="muted" style="margin-top:6px;">Bounding boxes are scaled to the displayed size.</p>

          <script>
            // Data passed from server
            const boxes = {{ results.image_hit_boxes|tojson }};
            const naturalSize = {{ (natural_size or {})|tojson }};

            function drawBoxes() {
              const img = document.getElementById('ocrImg');
              const wrap = document.getElementById('imgWrap');

              // Remove old overlays
              document.querySelectorAll('.overlay').forEach(el => el.remove());

              if (!img || !naturalSize || !naturalSize.width || boxes.length === 0) return;

              // Current displayed size of the image
              const dispW = img.clientWidth;
              const dispH = img.clientHeight;

              // Scale factors between natural (OCR coords) and displayed size
              const sx = dispW / naturalSize.width;
              const sy = dispH / naturalSize.height;

              boxes.forEach(b => {
                const div = document.createElement('div');
                div.className = 'overlay';
                div.style.left = (b.x * sx) + 'px';
                div.style.top = (b.y * sy) + 'px';
                div.style.width = (b.w * sx) + 'px';
                div.style.height = (b.h * sy) + 'px';
                wrap.appendChild(div);
              });
            }

            // Draw on load and on resize
            window.addEventListener('load', drawBoxes);
            window.addEventListener('resize', drawBoxes);
          </script>

          <div style="margin-top:16px;">
            <h4>Extracted Text</h4>
            <pre style="white-space:pre-wrap;">{{ results.image_text_html|safe }}</pre>
          </div>
        {% else %}
          <p class="muted">No image to display.</p>
        {% endif %}
      {% endif %}
    </div>
  {% endif %}

  <div class="footer">
    <p>Tip: If image OCR returns “Tesseract not found”, install the Tesseract binary on your host and (optionally) set <code>TESSERACT_CMD</code> env var.</p>
  </div>
</body>
</html>
